<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.aisino.passport.sys.dao.IAosResourceDao">
	
	<select id="queryUserRes" parameterType="XHashMap" resultType="XHashMap" >
		SELECT
			r.*
		FROM
			aos_user u
		INNER JOIN aos_user_duty u_duty ON u.userid = u_duty.userid
		INNER JOIN aos_duty_role d_role ON u_duty.dutyid = d_role.dutyid
		INNER JOIN aos_role_res r_res ON r_res.roleid = d_role.roleid
		INNER JOIN aos_resource r ON r.resid = r_res.resid
		WHERE u.available = 1
		AND u_duty.available = 1
		AND d_role.available = 1
		AND r_res.available = 1
		AND r.available = 1
		AND u.userid = #{userid}
		AND r.pid = #{pid}
	</select>
	
	
	<!-- 查询资源树 -->
	<select id="querySystemRes" parameterType="XHashMap" resultType="XHashMap" >
		select 
				<if test="userid != null and userid !=''"> 
			    usermenu.resid as checked, 
			    </if>
			    (select count(1) from aos_resource r where r.pid = res.resid) as leaf_node,
			    res.resid as id, res.resname as name, res.pid, res.restype, res.rescode
			from
			    aos_resource res
			<if test="userid != null and userid !=''"> 
			        left join
			    (select 
			        r.resid
			    from
			        aos_user u
			    inner join aos_user_duty u_duty ON u.userid = u_duty.userid
			    inner join aos_duty_role d_role ON u_duty.dutyid = d_role.dutyid
			    inner join aos_role_res r_res ON r_res.roleid = d_role.roleid
			    inner join aos_resource r ON r.resid = r_res.resid
			    where
			        u.available = 1 and u_duty.available = 1
			            and d_role.available = 1
			            and r_res.available = 1
			            and r.available = 1
						and 	u.userid = #{userid}
			            ) usermenu ON res.resid = usermenu.resid
		      </if>
			where
			    res.available = 1
			    <if test="pid != null and pid !=''"> and 
					res.pid = #{pid}
				</if>
				<if test="rescode != null and rescode !=''"> and 
					res.rescode = #{rescode}
				</if>
				<if test="identitytype != null and identitytype !=''"> and 
					res.identitytype = ${identitytype}
				</if>
				<if test="resname != null and resname !=''"> and 
					res.resname like '%${resname}%'
				</if>
				<if test="restype != null and restype !=''"> and 
					res.restype = #{restype}
				</if>
	</select>
	
	
	
	<select id="findList" parameterType="AosResource" resultType="AosResource" >
		select 
				t.resid, t.resname, t.restype, t.identitytype, t.url, t.rescode, t.pid, t.resicon, t.available,
				(select r.resname from aos_resource r where r.resid = t.pid) as pname
			from aos_resource t 
			
			where 1 = 1  
			<if test="resid != null and resid !=''"> and 
				t.resid = #{resid}
			</if>
			<if test="resname != null and resname !=''"> and 
				t.resname like  concat(concat('%',#{resname}),'%')
			</if>
			<if test="restype != null and restype !=''"> and 
				t.restype = #{restype}
			</if>
			<if test="identitytype != null and identitytype !=''"> and 
				t.identitytype = ${identitytype}
			</if>
			<if test="url != null and url !=''"> and 
				t.url = #{url}
			</if>
			<if test="rescode != null and rescode !=''"> and 
				t.rescode = #{rescode}
			</if>
			<if test="pid != null and pid !=''"> and 
				(t.pid = #{pid} or t.resid = #{pid})
			</if>
			<if test="resicon != null and resicon !=''"> and 
				t.resicon = #{resicon}
			</if>
			<if test="available != null and available !=''"> and 
				t.available = ${available}
			</if>
	</select>

	<select id="get" parameterType="AosResource" resultType="AosResource" >
		select 
				t.resid, t.resname, t.restype, t.identitytype, t.url, t.rescode, t.pid, t.resicon, t.available,
				(select r.resname from aos_resource r where r.resid = t.pid) as pname
			from aos_resource t 
			
			where 1 = 1  
			<if test="resid != null and resid !=''"> and 
				t.resid = #{resid}
			</if>
			<if test="resname != null and resname !=''"> and 
				t.resname = #{resname}
			</if>
			<if test="restype != null and restype !=''"> and 
				t.restype = #{restype}
			</if>
			<if test="identitytype != null and identitytype !=''"> and 
				t.identitytype = ${identitytype}
			</if>
			<if test="url != null and url !=''"> and 
				t.url = #{url}
			</if>
			<if test="rescode != null and rescode !=''"> and 
				t.rescode = #{rescode}
			</if>
			<if test="pid != null and pid !=''"> and 
				t.pid = #{pid}
			</if>
			<if test="resicon != null and resicon !=''"> and 
				t.resicon = #{resicon}
			</if>
			<if test="available != null and available !=''"> and 
				t.available = ${available}
			</if>
	</select>

	<insert id="insert" parameterType="AosResource">
		insert into aos_resource
			(resid 
		<if test="resname != null and resname !=''"> , resname</if>
		<if test="restype != null and restype !=''"> , restype</if>
		<if test="identitytype != null and identitytype !=''"> , identitytype</if>
		<if test="url != null and url !=''"> , url</if>
		<if test="rescode != null and rescode !=''"> , rescode</if>
		<if test="pid != null and pid !=''"> , pid</if>
		<if test="resicon != null and resicon !=''"> , resicon</if>
		<if test="available != null and available !=''"> , available</if>
		)
		values 			(#{resid} 
		<if test="resname != null and resname !=''"> , #{resname}</if>
		<if test="restype != null and restype !=''"> , #{restype}</if>
		<if test="identitytype != null and identitytype !=''"> , ${identitytype}</if>
		<if test="url != null and url !=''"> , #{url}</if>
		<if test="rescode != null and rescode !=''"> , #{rescode}</if>
		<if test="pid != null and pid !=''"> , #{pid}</if>
		<if test="resicon != null and resicon !=''"> , #{resicon}</if>
		<if test="available != null and available !=''"> , ${available}</if>
		)

	</insert>

	<update id="update" parameterType="AosResource">
		update aos_resource 
			set resid   = #{resid}

				<if test="resname != null and resname !=''"> , resname = #{resname}</if>
				<if test="restype != null and restype !=''"> , restype = #{restype}</if>
				<if test="identitytype != null and identitytype !=''"> , identitytype = ${identitytype}</if>
				<if test="url != null and url !=''"> , url = #{url}</if>
				<if test="rescode != null and rescode !=''"> , rescode = #{rescode}</if>
				<if test="pid != null and pid !=''"> , pid = #{pid}</if>
				<if test="resicon != null and resicon !=''"> , resicon = #{resicon}</if>
				<if test="available != null and available !=''"> , available = ${available}</if>
		where resid = #{resid}
	</update>

	<delete id="delete" parameterType="AosResource">
		delete from aos_resource  where resid = #{resid}
	</delete>

</mapper>
