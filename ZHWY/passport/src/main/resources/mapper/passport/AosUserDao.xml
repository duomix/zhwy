<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.aisino.passport.sys.dao.IAosUserDao">

	<!-- 根据用户查询用户可使用系统 -->
	<select id="queryUserResSystem" parameterType="XHashMap" resultType="XHashMap" >
		select 
		    ud.userid, r . *
		from
		    aos_resource r
		        inner join
		    aos_role_res rr ON rr.resid = r.resid
		        inner join
		    aos_duty_role dr ON dr.roleid = rr.roleid
		        inner join
		    aos_user_duty ud ON ud.dutyid = dr.dutyid
		where
		    r.restype = '1'
		        and ud.userid = #{userid}
		        and r.available = '1'
		        and rr.available = '1'
		        and dr.available = '1'
		        and ud.available = '1'
	</select>

	<select id="findList" parameterType="AosUser" resultType="AosUser" >
		select 
				t.userid, t.username, t.user_img, t.account, t.password, t.status, t.identitytype, t.lastlogintime, t.createdate, t.createby, t.issys, t.available,
				ud.dutyid as dutyid_main, d.dutyname as dutyname_main, d.deptid,
    			dept.deptname
			from aos_user t 
				left join
		    aos_user_duty ud ON t.userid = ud.userid and ud.ismain = '1'
		        left join
		    aos_duty d ON ud.dutyid = d.dutyid
		    	inner join
   			aos_dept dept ON d.deptid = dept.deptid
			where 1 = 1  and  t.available = 1
			<if test="deptid != null and deptid !=''"> and 
				dept.deptid = #{deptid}
			</if>
			<if test="userid != null and userid !=''"> and 
				t.userid = #{userid}
			</if>
			<if test="username != null and username !=''"> and 
				t.username = #{username}
			</if>
			<if test="user_img != null and user_img !=''"> and 
				t.user_img = #{user_img}
			</if>
			<if test="account != null and account !=''"> and 
				(	
					t.account like  concat(concat('%',#{account}),'%')
					or 
					t.username like  concat(concat('%',#{account}),'%')
				)	
			</if>
			<if test="password != null and password !=''"> and 
				t.password = #{password}
			</if>
			<if test="status != null and status !=''"> and 
				t.status = ${status}
			</if>
			<if test="identitytype != null and identitytype !=''"> and 
				t.identitytype = ${identitytype}
			</if>
			<if test="lastlogintime != null and lastlogintime !=''"> and 
				t.lastlogintime = #{lastlogintime}
			</if>
			<if test="createdate != null and createdate !=''"> and 
				t.createdate = #{createdate}
			</if>
			<if test="createby != null and createby !=''"> and 
				t.createby = #{createby}
			</if>
			<if test="issys != null and issys !=''"> and 
				t.issys = ${issys}
			</if>
			order by t.createdate desc
	</select>

	<select id="get" parameterType="AosUser" resultType="AosUser" >
		select 
				t.userid, t.username, t.user_img, t.account, t.password, t.status, t.identitytype, t.lastlogintime, t.createdate, t.createby, t.issys, t.available, 
				ud.dutyid as dutyid_main, d.dutyname as dutyname_main
			from aos_user t 
			left join
		    aos_user_duty ud ON t.userid = ud.userid and ud.ismain = '1'
		        left join
		    aos_duty d ON ud.dutyid = d.dutyid
			where 1 = 1  and  t.available = 1
			<if test="userid != null and userid !=''"> and 
				t.userid = #{userid}
			</if>
			<if test="username != null and username !=''"> and 
				t.username = #{username}
			</if>
			<if test="user_img != null and user_img !=''"> and 
				t.user_img = #{user_img}
			</if>
			<if test="account != null and account !=''"> and 
				t.account = #{account}
			</if>
			<if test="password != null and password !=''"> and 
				t.password = #{password}
			</if>
			<if test="status != null and status !=''"> and 
				t.status = ${status}
			</if>
			<if test="identitytype != null and identitytype !=''"> and 
				t.identitytype = ${identitytype}
			</if>
			<if test="lastlogintime != null and lastlogintime !=''"> and 
				t.lastlogintime = #{lastlogintime}
			</if>
			<if test="createdate != null and createdate !=''"> and 
				t.createdate = #{createdate}
			</if>
			<if test="createby != null and createby !=''"> and 
				t.createby = #{createby}
			</if>
			<if test="issys != null and issys !=''"> and 
				t.issys = ${issys}
			</if>
	</select>

	<insert id="insert" parameterType="AosUser">
		insert into aos_user
			(userid 
		<if test="username != null and username !=''"> , username</if>
		<if test="user_img != null and user_img !=''"> , user_img</if>
		<if test="account != null and account !=''"> , account</if>
		<if test="password != null and password !=''"> , password</if>
		<if test="status != null and status !=''"> , status</if>
		<if test="identitytype != null and identitytype !=''"> , identitytype</if>
		<if test="lastlogintime != null and lastlogintime !=''"> , lastlogintime</if>
		<if test="createdate != null and createdate !=''"> , createdate</if>
		<if test="createby != null and createby !=''"> , createby</if>
		<if test="issys != null and issys !=''"> , issys</if>
		<if test="available != null and available !=''"> , available</if>
		)
		values 			(#{userid} 
		<if test="username != null and username !=''"> , #{username}</if>
		<if test="user_img != null and user_img !=''"> , #{user_img}</if>
		<if test="account != null and account !=''"> , #{account}</if>
		<if test="password != null and password !=''"> , #{password}</if>
		<if test="status != null and status !=''"> , ${status}</if>
		<if test="identitytype != null and identitytype !=''"> , ${identitytype}</if>
		<if test="lastlogintime != null and lastlogintime !=''"> , #{lastlogintime}</if>
		<if test="createdate != null and createdate !=''"> , #{createdate}</if>
		<if test="createby != null and createby !=''"> , #{createby}</if>
		<if test="issys != null and issys !=''"> , ${issys}</if>
		<if test="available != null and available !=''"> , ${available}</if>
		)

	</insert>

	<update id="update" parameterType="AosUser">
		update aos_user 
			set userid   = #{userid}

				<if test="username != null and username !=''"> , username = #{username}</if>
				<if test="user_img != null and user_img !=''"> , user_img = #{user_img}</if>
				<if test="account != null and account !=''"> , account = #{account}</if>
				<if test="password != null and password !=''"> , password = #{password}</if>
				<if test="status != null and status !=''"> , status = ${status}</if>
				<if test="identitytype != null and identitytype !=''"> , identitytype = ${identitytype}</if>
				<if test="lastlogintime != null and lastlogintime !=''"> , lastlogintime = #{lastlogintime}</if>
				<if test="createdate != null and createdate !=''"> , createdate = #{createdate}</if>
				<if test="createby != null and createby !=''"> , createby = #{createby}</if>
				<if test="issys != null and issys !=''"> , issys = ${issys}</if>
				<if test="available != null and available !=''"> , available = ${available}</if>
		where userid = #{userid}
	</update>

	<delete id="delete" parameterType="AosUser">
		update aos_user 
			set 
			    available = 0
			where
			    userid = #{userid}
	</delete>
	
	<!-- 根据用户账户查找角色集合 -->
	<select id="findUserRoleList" parameterType="java.lang.String" resultType="java.lang.String" >
		select 
		    r.rolecode
		from
		    aos_duty_role dr
		        inner join
		    aos_user_duty ud ON dr.dutyid = ud.dutyid
		        inner join
		    aos_user u ON u.userid = ud.userid
		        inner join
		    aos_role r ON r.roleid = dr.roleid and u.identitytype = r.identitytype
		where 1 = 1 and u.available = 1
		<if test="account != null and account !=''"> and 
		    u.account = #{account}
			</if>
	</select>
	<!-- 根据用户账户查找资源集合 -->
	<select id="findUserResList" parameterType="java.lang.String" resultType="java.lang.String" >
		select 
		    r.rescode
		from
		    aos_duty_role dr
		        inner join
		    aos_user_duty ud ON dr.dutyid = ud.dutyid
		        inner join
		    aos_user u ON u.userid = ud.userid
		        inner join
		    aos_role_res rr ON rr.roleid = dr.roleid
		        left join
		    aos_resource r ON r.resid = rr.resid and u.identitytype = r.identitytype
		where 1 = 1 and u.available = 1
		<if test="account != null and account !=''"> and 
		    u.account = #{account}
			</if>
	</select>

</mapper>
